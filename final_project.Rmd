---
title: "Does Allen's rule apply to ..."
author: "Karim Bolis u6671566"
date: "14/10/23"
output:  
    html_document:
        toc: true
        toc_depth: 4
        theme: cosmo
        number_sections: false
        toc_float: true
        highlight: pygments
        fig_width: 8
        fig_height: 4
---

# Word/figure count

                                                  NEED WORD COUNT AND FIGURE COUNT


Words:
Figures:

# Location on GitHub

https://github.com/karim-bolis/DS4B-final-project

# Data Description

Avonet is an open-source database of morphological, geographical and ecological data for all bird species. It was compiled by Catherine Sheard and Joseph Tobias to serve as a tool for testing out theories in evolutionary biology, ecology and ecosystem science for the birds. (Tobias et al. 2021)

# Questions/Aims

[A brief section which first states and then justifies the questions/aims of your EDA. Must provide evidence of independent research into what has been done before on these questions/aims. See above for examples.]

# Raw data

Download the file named "AVONET from Supplementary dataset 1.xlsx" from https://figshare.com/articles/dataset/AVONET_morphological_ecological_and_geographical_data_for_all_birds_Tobias_et_al_2021_Ecology_Letters_/16586228.

WorldClim data is downloaded below.

```{r}
library(raster)
library(readxl)

worldclim = getData("worldclim",var="bio",res=2.5, path="raw_data")

```

# Data wrangling

```{r}
library(tidyverse)

raw_avonet = read_excel("raw_data/AVONET Supplementary dataset 1.xlsx", sheet=4)
avonet = as_tibble(raw_birdtree)
avonet = avonet %>%
  mutate(row_id = row_number()) %>%
  select(row_id, everything()) %>%
  mutate(Min.Latitude=as.double(Min.Latitude)) %>%
  mutate(Max.Latitude=as.double(Max.Latitude)) %>%
  mutate(Centroid.Latitude=as.double(Centroid.Latitude)) %>%
  mutate(Centroid.Longitude=as.double(Centroid.Longitude)) %>%
  mutate(Range.Size=as.double(Range.Size)) %>%
  mutate(Hand.Wing.Index=`Hand-Wing.Index`)

write_csv(avonet, file = "processed_data/tidied_data.csv")

excluded_data <- read_csv("processed_data/excluded_data.csv")
tidied_data <- read_csv("processed_data/tidied_data.csv")
cleaned_data <- tidied_data %>%
  anti_join(excluded_data, by = "row_id")

write_csv(cleaned_data, file = "processed_data/cleaned_data.csv")

avonet <- read_csv("processed_data/cleaned_data.csv")

```

# Sanity checks

Most of the sanity checking was done in the data cleaning document. These extra checks ensure that data types are consistent with how they appear, that all species have location information to find their living range mean annual temperature and that none of the traits studied have been inferred from close relatives.

```{r}

summary(avonet)

any(is.na(avonet$Centroid.Latitude))
any(is.na(avonet$Centroid.Longitude))

unique(avonet$Traits.inferred)

```

                                                # Does Allen's rule apply to...


                                              [Use appropriate sub-headings]
# Report

## Introduction


As the climate gets hotter, ornithologists have found shifts in bird sizes, geographic ranges and phenology. (Tian & Benton 2020, Baldwin et al. 2023) This has sparked an interest in predicting future shifts using biogeographical rules which summarise large global trends. (Tian & Benton 2020) Allen's rule, one of the oldest ones, states that in hotter climates, endotherm appendages tend to become larger, as the increase in surface-area-to-volume ratio results in more heat exchange with the environment. (Allen 1877) Allen's rule has been studied extensively, often in conjunction with Bergmann's rule, which links body size with temperature. (Xu 2023, Symonds & Tattersall 2010,  Fohlich et al. 2023, Baldwin et al. 2023) Yet, published literature has only looked into bird beak dimensions and tarsus (foot) length as appendage size representatives, often neglecting wings and tails. The presence of feathering on these appendages may complicate results. During flight, birds lose 99% of the heat generated, mostly through their wings, yet heat conservation is also achieved by holding the wings close to one's torso (Weeks et al. 2023). Similarly, beaks are simultaneously involved in both heat dissipation and cold tolerance (Weeks et al. 2023) This study aims to understand how Wing and Tail Length factor into Allen's rule across the world's species.

## Obtaining annual temperature

World Mean annual temperature data was downloaded from WorldClim above, who store data from 1970-2000 for the whole world. Using the raster package function "extract", I found the temperature for every lat/long spatial point representing the centre of a species living range. I filtered out species with no temperature as a result of their living range being too remote for data collection.

```{r}
library(raster)
library(sp)

worldclim <- worldclim[[1]]
plot(worldclim)

get_mean_annual_temp <- function(climate_data, lat, long) {
  point = SpatialPoints(data.frame(longitude = long, latitude = lat), proj4string = climate_data@crs)
  return(raster::extract(climate_data, point))
}

avonet = avonet %>%
  mutate(mean_annual_temp = get_mean_annual_temp(worldclim, Centroid.Latitude, Centroid.Longitude)/10)

avonet = filter(avonet, !is.na(mean_annual_temp))

# check temperature data was added
head(avonet)

```

## PCA

The distributions of wing and tail length seen in the violin plot show that while most values sit within a small range for both, there is a lot of outliers. Graphing them shows they have a linear relationship with narrow confidence intervals. To quantify the effect size, I found their pearson and spearman correlation coefficients. While both coefficients assume a linear relationship, pearson is heavily affected by outliers, so spearman performs better.

This strong relationship indicates that a Principal component analysis, which reduces data dimensionality, could provide a way to capture both sets of data and provide a stronger correlate with mean annual temperature. This technique was previously used to capture bill size from its 4 dimensional measurments. (Baldwin et al. 2023) The first principal component, capturing 86% of both variables, was added to avonet.

```{r}
library(psych)

summary(avonet$Wing.Length)
summary(avonet$Tail.Length)

ggplot(avonet, aes(x = 1, y = Wing.Length)) +
  geom_violin(fill = "blue") +
  labs(y = "Trait Value") +
  labs(x = "Distributions") +
  geom_violin(data = avonet, aes(x = 2, y = Tail.Length), fill = "red") +
  scale_x_continuous(breaks = c(1, 2), labels = c("Wing Length", "Tail Length"))

ggplot(avonet, aes(x = Wing.Length, y = Tail.Length)) +
  geom_point(size = 0.01) +
  scale_y_log10() +
  geom_smooth(method = 'lm', se=TRUE, level=0.99999999)

correlation_value_pearson = cor(avonet$Wing.Length, avonet$Tail.Length, method = "pearson")
correlation_value_spearman = cor(avonet$Wing.Length, avonet$Tail.Length, method = "spearman")
print(correlation_value_pearson)
print(correlation_value_spearman)

pca_model = principal(select(avonet,Wing.Length,Tail.Length), nfactors = 2, rotate='none')
summary(pca_model)

pc1 = pca_model$scores[,1]

avonet$wing_tail_pc1 = pc1

head(avonet)


```

## Correlations

I chose to study family-level correlations, as families usually contain a sufficiently large temperature range and number of species, keeping potentially confounding effects of morphology, behavior, and ecology variation low. Additionally, families have vastly different trait value distributions, as seen in the histograms. The families studied were filtered to favor a temperature range and no. of species > 10. Initial results surprisingly showed that both wing and tail length negatively correlated with temperature across the data, with varying significance. To dig deeper, I first found the distribution of p values across families for each trait using boxplots. This showed that most relationships are not significant for the traits, with only the Hand-Wing Index median falling at or below the 0.05 threshold. While the significant relationship counts featured some for all traits, Tail Length, The Hand-Wing Index (HWI) and Kipps Distance contained the most. The PC1 from the Wing/Tail Length PCA seems to show a correlation between the two traits, rather than improving on them.

The HWI is a metric of flight efficiency and ability to disperse in birds (Tobias et al. 2021). It is equivalent to Kipps' length, explaining their similar numbers, and is not a measure of appendage length, more of relative ratios. (Sheard et al. 2020) Research has suggested that tropical species in hotter climates have less dispersal ability, increasing their sensitivity to habitat disturbance. (Sheard et al. 2020) This fits the trend shown here.
Assessing the families with the most correlation (by correlation coefficient) for the highly correlated traits shows that the  Remizidae family consistently shows the clearest negative trend between mean annual temperature and wing length, HWI, Kipps' distance and Tail Length, in some cases showing a correlation that explains 77% of the trait's variation through the mean annual temperature (r=-0.88^2 --> R=0.77).




frohlich said the trend reverses in smaller birds, and that's what I found!!




Ecological predictors of interspecific variation in bird bill and leg lengths on a global scale: they found opposite effects in passerines vs non-passerines in bird dimensions

```{r}
Anatidae_Tyrannidae <- avonet %>%
  filter(Family3 %in% c("Anatidae", "Tyrannidae"))

ggplot(Anatidae_Tyrannidae, aes(x = Wing.Length)) +
  geom_histogram(fill = "blue", color = "black") +
  facet_wrap(~Family3, ncol = 2) +
  labs(x = "Wing Length", y = "Frequency") +
  ggtitle("Histograms of PC1 Values for Anatidae and Tyrannidae")





avonet = avonet %>%
  group_by(Family3) %>%
  mutate(temp_range=max(mean_annual_temp)-min(mean_annual_temp))

avonet = filter(avonet,temp_range>10)

avonet = avonet %>%
  group_by(Family3) %>%
  mutate(no_species_in_family=n())

avonet = filter(avonet,no_species_in_family>10)





cat("Wing Length p-value:",cor.test(avonet$mean_annual_temp,avonet$Wing.Length)$p.value,"correlation coefficient:",cor(avonet$mean_annual_temp,avonet$Wing.Length),"\n")

cat("Tail Length p-value:",cor.test(avonet$mean_annual_temp,avonet$Tail.Length)$p.value,"correlation coefficient:",cor(avonet$mean_annual_temp,avonet$Tail.Length),"\n")

ggplot(avonet, aes(x = mean_annual_temp, y = Wing.Length)) +
  scale_y_log10() +
  geom_point(size = 0.01) +
  geom_smooth(method = 'lm') +
  labs(title = "Correlation of Wing Length & Mean Annual Temperature across all families") +
  theme(plot.title = element_text(size = 12))

ggplot(avonet, aes(x = mean_annual_temp, y = Tail.Length)) +
  scale_y_log10() +
  geom_point(size = 0.01) +
  geom_smooth(method = 'lm') +
  labs(title = "Correlation of Tail Length & Mean Annual Temperature across all families") +
  theme(plot.title = element_text(size = 12))

correlation_values <- avonet %>%
  group_by(Family3) %>%
  summarize(
    p_value_Wing_Length = cor.test(mean_annual_temp, Wing.Length)$p.value,
    r_value_Wing_Length = cor(mean_annual_temp, Wing.Length),
    p_value_Tail_Length = cor.test(mean_annual_temp, Tail.Length)$p.value,
    r_value_Tail_Length = cor(mean_annual_temp, Tail.Length),
    p_value_wing_tail_pc1 = cor.test(mean_annual_temp, wing_tail_pc1)$p.value,
    r_value_wing_tail_pc1 = cor(mean_annual_temp, wing_tail_pc1),
    p_value_Secondary1 = cor.test(mean_annual_temp, Secondary1)$p.value,
    r_value_Secondary1 = cor(mean_annual_temp, Secondary1),
    p_value_Hand_Wing_Index = cor.test(mean_annual_temp, Hand.Wing.Index)$p.value,
    r_value_Hand_Wing_Index = cor(mean_annual_temp, Hand.Wing.Index),
    p_value_Kipps_dist = cor.test(mean_annual_temp, Kipps.Distance)$p.value,
    r_value_Kipps_dist = cor(mean_annual_temp, Kipps.Distance)
  ) %>%
  ungroup()

head(correlation_values)

summary(correlation_values)


correlations_modified <- correlation_values %>%
  pivot_longer(
    cols = starts_with("p_value_"),
    names_to = "trait_p",
    values_to = "p_value"
  ) %>%
  pivot_longer(
    cols = starts_with("r_value_"),
    names_to = "trait_r",
    values_to = "r_value"
  )


head(correlations_modified)



ggplot(correlations_modified, aes(x=trait_p, y=p_value)) +
  geom_boxplot()

ggplot(correlation_values, aes(x = 1, y = p_value_Wing_Length)) +
  geom_boxplot(fill = "blue") +
  labs(y = "Trait p-values") +
  labs(x = "Distributions") +
  geom_boxplot(data = correlation_values, aes(x = 2, y = p_value_Tail_Length), fill = "black") +
  geom_boxplot(data = correlation_values, aes(x = 3, y = p_value_wing_tail_pc1), fill = "green") +
  geom_boxplot(data = correlation_values, aes(x = 4, y = p_value_Secondary1), fill = "red") +
  geom_boxplot(data = correlation_values, aes(x = 5, y = p_value_Hand_Wing_Index), fill = "purple") +
  geom_boxplot(data = correlation_values, aes(x = 6, y = p_value_Kipps_dist), fill = "yellow") +
  geom_hline(yintercept = 0.05, linetype = "dashed") +
  scale_x_continuous(breaks = c(1, 2, 3, 4, 5, 6), labels = c("Wing Length","Tail Length","Wing Tail PC1","Secondary Length", "Hand-Wing Index", "Kipps Distance")) +
  labs(title = "Distribution of P values of trait/temperature correlations across families") +
  theme(plot.title = element_text(size = 12))


# ggplot(correlation_values, aes(x = 1, y = r_value_Wing_Length)) +
#   geom_boxplot(fill = "blue") +
#   geom_point(fill = "blue") +
#   labs(y = "Trait r-values") +
#   labs(x = "Distributions") +
#   geom_boxplot(data = correlation_values, aes(x = 2, y = r_value_Tail_Length), fill = "black") +
#   
#   geom_boxplot(data = correlation_values, aes(x = 3, y = r_value_wing_tail_pc1), fill = "green") +
#   geom_boxplot(data = correlation_values, aes(x = 4, y = r_value_Secondary1), fill = "red") +
#   geom_boxplot(data = correlation_values, aes(x = 5, y = r_value_Hand_Wing_Index), fill = "purple") +
#   geom_boxplot(data = correlation_values, aes(x = 6, y = r_value_Kipps_dist), fill = "yellow") +
#   scale_x_continuous(breaks = c(1, 2, 3, 4, 5, 6), labels = c("Wing Length","Secondary Length","Wing Tail PC1","Hand-Wing Index", "Kipps Distance", "Tail Length")) +
#   labs(title = "Distribution of r values of trait/temperature correlations across families") +
#   theme(plot.title = element_text(size = 12))

head(correlation_values)


nrow(filter(correlation_values,p_value_Wing_Length<0.05))
nrow(filter(correlation_values,p_value_Tail_Length<0.05))
nrow(filter(correlation_values,p_value_wing_tail_pc1<0.05))
nrow(filter(correlation_values,p_value_Secondary1<0.05))
nrow(filter(correlation_values,p_value_Hand_Wing_Index<0.05))
nrow(filter(correlation_values,p_value_Kipps_dist<0.05))

head(correlation_values)

# ggplot(correlation_values, aes(x=flowcell, y=total_output_MB, colour=flowcell)) +
#   geom_violin() +
#   geom_jitter(size=0.5, alpha=0.5, width = 0.1) + 
#   theme_minimal()





















extreme_family_finder <- function(correlations,trait) {
  p_values = paste("p_value_",trait,sep = "")
  r_values = paste("r_value_",trait,sep = "")
  
  trait_significant_correlations = correlations %>%
    select(Family3,!!sym(p_values),!!sym(r_values)) %>%
    filter(!!sym(p_values)<0.05)
  
  most_negative = trait_significant_correlations %>%
    arrange(!!sym(r_values)) %>%
    slice(1)
  
  most_positive = trait_significant_correlations %>%
    arrange(desc(!!sym(r_values))) %>%
    slice(1)
  
  print(most_negative)
  print(most_positive)
}



# Examining Wing Length
extreme_family_finder(correlation_values,"Wing_Length")

# Examining Kipps Distance
extreme_family_finder(correlation_values,"Kipps_dist")

# Examining Tail Length
extreme_family_finder(correlation_values,"Tail_Length")

# Examining HWI
extreme_family_finder(correlation_values,"Hand_Wing_Index")

Remizidae_data = filter(avonet,Family3=="Remizidae")
Remizidae_lm = lm(data = Remizidae_data, Hand.Wing.Index ~ mean_annual_temp)
summary(Remizidae_lm)

nrow(Remizidae_data)

ggplot(Remizidae_data, aes(x = mean_annual_temp, y = Hand.Wing.Index)) +
  scale_y_log10() +
  geom_point(size = 0.01) +
  geom_smooth(method = 'lm')

# Musophagidae_data = filter(avonet,Family3=="Musophagidae")
# Musophagidae_lm = lm(data = Musophagidae_data, Hand.Wing.Index ~ mean_annual_temp)
# summary(Musophagidae_lm)
# 
# nrow(Musophagidae_data)
# 
# ggplot(Musophagidae_data, aes(x = mean_annual_temp, y = Hand.Wing.Index)) +
#   scale_y_log10() +
#   geom_point(size = 0.01) +
#   geom_smooth(method = 'lm')

```












# References

Tobias, J. A., Sheard, C., Pigot, A. L., Devenish, A. J. M., Yang, J., Sayol, F., Neate-Clegg, M. H. C., Alioravainen, N., Weeks, T. L., Barber, R. A., Walkden, P. A., MacGregor, H. E. A., Jones, S. E. I., Vincent, C., Phillips, A. G., Marples, N. M., Montaño-Centellas, F. A., Leandro-Silva, V., Claramunt, S., … Schleuning, M. (2021). AVONET: morphological, ecological and geographical data for all birds, Ecology Letters (Vol. 25, Issue 3)

for the compare_df_cols function in the janitor package: https://stackoverflow.com/questions/53264993/comparing-column-names-in-r-across-various-data-frames

Allen, J. A. (1877) The influence of physical conditions in the genesis of species, Radic. Rev. (Vol. 1, pp. 108–140.)














